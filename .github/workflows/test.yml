name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript type check
        run: npm run lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Run unit tests with coverage
        run: npm run test:coverage -- --reporter=verbose
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run integration tests
        run: npm run test:integration

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run E2E tests
        run: npm run test:e2e

  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
          - os: macos-latest
            target: macos
          - os: windows-latest
            target: windows
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Build binary
        run: npm run pkg:${{ matrix.target }}
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: binaries/
          retention-days: 7

  test-binaries:
    name: Test Binaries
    runs-on: ${{ matrix.os }}
    needs: build-binaries
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
            binary: lecoder-cgpu-linux-x64
          - os: macos-latest
            target: macos
            binary: lecoder-cgpu-macos-x64
          - os: windows-latest
            target: windows
            binary: lecoder-cgpu-win-x64.exe
    steps:
      - uses: actions/checkout@v4
      
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: binaries/
      
      - name: Make binary executable (Unix)
        if: matrix.os != 'windows-latest'
        run: chmod +x binaries/${{ matrix.binary }}
      
      - name: Test binary version
        run: binaries/${{ matrix.binary }} --version
      
      - name: Test binary help
        run: binaries/${{ matrix.binary }} --help

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, e2e-tests, test-binaries]
    steps:
      - name: All tests passed
        run: echo "All tests passed successfully!"
